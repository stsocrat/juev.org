<!DOCTYPE html>
<!--
    You can email me with PGP-key: 0xE8ADA1A55B3CA4EA
-->
<html lang="ru">
<head>
  <link rel="dns-prefetch" href="https://static.juev.org">
  <meta charset="utf-8">
  <title>StumpWM</title>
  <meta name="description" content="Я уже рассматривал простой тайловый оконный менеджер, который очень удобен в работе – RatPoison.  Проблема заключается только в том, что данный оконный менеджер можно настраивать только в рамках, п...">
  <meta name="yandex-verification" content="59bb4b98872e096b" />
  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- end -->
  <link rel="canonical" href="https://www.juev.org/2009/09/27/stumpwm/">
  <link rel="shortcut icon" href="https://static.juev.org/favicon.ico">
  <link rel="apple-touch-icon" href="https://www.juev.org/apple-touch-icon.png">
  <link rel="alternate" type="application/atom+xml" title="ATOM Feed" href="https://www.juev.org/atom.xml">
  <link rel="stylesheet" type="text/css" href="https://static.juev.org/assets/css/master.6bbfa8b61.css">
  <link rel="prev" href="https://www.juev.org/2009/09/13/xbindkeys/">
  <link rel="next" href="https://www.juev.org/2009/09/29/dotpac/">
  <!-- og:meta -->
  <meta content="StumpWM" property="og:title">
  <meta content="Я уже рассматривал простой тайловый оконный менеджер, который очень удобен в работе – RatPoison.  Проблема заключается только в том, что данный оконный менеджер можно настраивать только в рамках, п..." property="og:description">
  <meta content="https://www.juev.org/2009/09/27/stumpwm/" property="og:url">
  <meta content="2009-09-27T00:00:00+04:00" property="article:published_time">
  <meta content="wm" property="article:tag">
  <meta content="lisp" property="article:tag">
  <meta content="emacs" property="article:tag">
  <meta content="https://static.juev.org/images/calvin.png" property="og:image">
  <meta content="https://denis.evsyukov.org" property="article:author">
  <!-- end og:meta  -->
  <!-- twitter card -->
  <meta content="summary_large_image" name="twitter:card">
  <meta content="StumpWM" name="twitter:title">
  <meta content="Я уже рассматривал простой тайловый оконный менеджер, который очень удобен в работе – RatPoison.  Проблема заключается только в том, что данный оконный менеджер можно настраивать только в рамках, п..." property="twitter:description">
  <meta content="https://www.juev.org/2009/09/27/stumpwm/" name="twitter:url">
  <meta content="https://static.juev.org/images/calvin.png" property="twitter:image:src">
  <!-- end twitter card -->
</head>
<body class="wide">
  <div class="navigation">
    <div class="width-fix">
        <a href="https://www.juev.org/" id="home" rel="nofollow"></a>
      <ul>
        <li><a href="https://www.juev.org/articles.html" rel="nofollow">Статьи</a></li>
        <li>|</li>
        <li><a href="https://denis.evsyukov.org">Об авторе</a></li>
      </ul>
    </div>
  </div>
  <div class="primary-content width-fix">
    <div class="entry"><h1 class="title">StumpWM</h1>
<div id="metainfo">
<span class="date">27 September 2009</span>
<span class="tags"><a href="https://www.juev.org/tags/#wm" title="View posts tagged with &quot;wm&quot;" rel="nofollow">#wm</a><a href="https://www.juev.org/tags/#lisp" title="View posts tagged with &quot;lisp&quot;" rel="nofollow">#lisp</a><a href="https://www.juev.org/tags/#emacs" title="View posts tagged with &quot;emacs&quot;" rel="nofollow">#emacs</a></span>
</div>
<div class="post"><p>Я уже рассматривал простой тайловый оконный менеджер, который очень удобен в работе – <a href="/2009/09/11/ratpoison/">RatPoison</a>. Проблема заключается только в том, что данный оконный менеджер можно настраивать только в рамках, предусмотренных программистами. И ничего более… К примеру, строку информации необходимо уже реализовывать с помощью внешних программ. Что порой бывает не удобно и порой не обладает достаточным функционалом.</p>

<p>Я уже несколько раз до сего момента обращал внимание на тайловый менеджер <strong>StumpWM</strong>, который написан на языке <em>Lisp</em> и который, судя по описанию, можно настраивать полностью, фактически переписывая код самого оконного менеджера. Но столкнулся с проблемами в установке, а потому довольно надолго оставлял эту затею.</p>

<p>Один раз мне удалось установить <strong>stumpwm</strong> непосредственно из <em>AUR</em>. Я об этом описывал в статье <a href="/2009/08/15/ustanovka-stumpwm/">Установка StumpWM</a>.
Но чуть позже, после того, как пакет был обновлен, сборка стала невозможна. Каждый раз прерывалась ошибками, то компиляции, то ошибками сборки самого пакета.</p>

<p>В конце концов Павел Вязовой подсказал мне, что не нужно собирать пакет. Достаточно только откомпилировать пакет и использовать при запуске указание полного пути до папки сбинарником. Что я, естественно, и сделал. Все оказалось много проще, чем я думал.</p>

<p>Подготавливаем систему к установке, для этого ставим пакеты<em>sbcl</em>, <em>cl-ppcre</em> и <em>git</em>, если они еще не были установлены до этого. И создаем файл <em>~/.sbclrc</em> со следующим содержимым:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(require 'asdf)
(pushnew #p"/usr/share/common-lisp/systems/" asdf:*central-registry* :test #'equal)
(asdf:operate 'asdf:load-op 'cl-ppcre)
</code></pre></div></div>

<p>Теперь выполняем следующие действия для установки <strong>stumpwm</strong>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone git://git.savannah.nongnu.org/stumpwm.git
$ cd stumpwm
$ autoconf &amp;&amp; ./configure &amp;&amp; make
</code></pre></div></div>

<p>Теперь прописываем в <em>~/.xinitrc</em> строку запуска данного оконного менеджера:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exec /PATH/TO/stumpwm
</code></pre></div></div>

<p>Теперь можно запускать иксы, или перезапускать их для входа в новое окружение.</p>

<p>Если вы ничего не увидите, не пугайтесь, все нормально. По умолчанию stumpwm не запускает никаких программ и не задает внешний вид своего окружения. Все, что необходимо, можно будет запускать из файла конфигурации <strong>stumpwm</strong> или из файла <em>~/.xinitrc</em>, который используется для запуска самого оконного менеджера. У меня данный файл выглядит так:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#</span>
<span class="c"># .xsession/.xinitrc</span>

<span class="nb">export </span><span class="nv">G_FILENAME_ENCODING</span><span class="o">=</span>@locale
<span class="nb">export </span><span class="nv">G_BROKEN_FILENAMES</span><span class="o">=</span>1

<span class="nb">export </span><span class="nv">OOO_FORCE_DESKTOP</span><span class="o">=</span>gnome
<span class="nb">export </span><span class="nv">GDK_USE_XFT</span><span class="o">=</span>1
<span class="nb">export </span><span class="nv">EDITOR</span><span class="o">=</span>emacsclient

<span class="c">#переключение раскладки</span>
<span class="c">#export LC_CTYPE=ru_RU.utf8</span>
<span class="nb">export </span><span class="nv">XMODIFIERS</span><span class="o">=</span><span class="s2">"@im=SCIM"</span>
<span class="nb">export </span><span class="nv">GTK_IM_MODULE</span><span class="o">=</span><span class="s2">"scim"</span>
<span class="nb">export </span><span class="nv">QT_IM_MODULE</span><span class="o">=</span><span class="s2">"scim"</span>
scim <span class="nt">-d</span> &amp;amp<span class="p">;</span>

<span class="c">#загрузка коинфига клавиш и внешнего вида</span>
xmodmap ~/.Xmodmap
xrdb ~/.Xdefaults

<span class="c"># D-bus</span>
<span class="k">if </span>which dbus-launch &amp;gt<span class="p">;</span>/dev/null &amp;amp<span class="p">;</span>&amp;amp<span class="p">;</span> <span class="nb">test</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$DBUS_SESSION_BUS_ADDRESS</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
 </span><span class="nb">eval</span> <span class="sb">`</span>dbus-launch <span class="nt">--sh-syntax</span> <span class="nt">--exit-with-session</span><span class="sb">`</span>
<span class="k">fi</span>

<span class="c">#установка параметров клавы, энергосбережения, шрифтов и скорости мыши</span>
xset r rate 350 30
xset <span class="nt">-dpms</span> &amp;amp<span class="p">;</span>
xset s off &amp;amp<span class="p">;</span>
xset fp+ /usr/share/fonts/local/
xset fp+ /usr/share/fonts/artwiz-fonts/
xset fp+ ~/.fonts/snap-11/
xset fp rehach
xset m 3

<span class="c">#установка рисунка рабочего стола</span>
<span class="nb">eval</span> <span class="sb">`</span><span class="nb">cat</span> ~/.fehbg<span class="sb">`</span> &amp;amp<span class="p">;</span>

<span class="c">#синхронизация буферов обмена</span>
autocutsel <span class="nt">-f</span>

<span class="c">#управление мышью логитех</span>
lomoco <span class="nt">-g</span> &amp;amp<span class="p">;</span>

<span class="c">#скрываем курсор мыши через определенное время</span>
unclutter <span class="nt">-idle</span> 20 &amp;amp<span class="p">;</span>

<span class="c"># run daemon scripts</span>
/etc/X11/Xsession

<span class="c">#запуск демона автомонтирования</span>
pgrep halevt &amp;gt<span class="p">;</span>&amp;gt<span class="p">;</span> /dev/null <span class="o">||</span> halevt &amp;amp<span class="p">;</span>

<span class="c">#установка темы курсоров</span>
xsetroot <span class="nt">-cursor_name</span> left_ptr &amp;amp<span class="p">;</span>

<span class="c">#включение композита</span>
xcompmgr <span class="nt">-a</span> &amp;amp<span class="p">;</span>

<span class="nb">exec</span> /home/git/stumpwm/stumpwm
</code></pre></div></div>

<p>По умолчанию в качестве префикса клавиш используется сочетание клавиш <em>C-t</em>, точно так же как и в крысином яде. Преимущества данного подхода очевидны, и были разобраны в ряде моих статей, поэтому не буду на нем останавливаться подробно.</p>

<p>Для того, чтобы изменить конфигурацию, внешний вид оконного менеджера, необходимо создать в домашней папке файл <strong>~/.stumpwmrc</strong>, который в дальнейшем редактируем. Текст файла представляет собой обычную программу на языке программирования <em>lisp</em>.</p>

<p>Для задания внешнего вида фреймов используется следующий код:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(set-font "-*-terminus-medium-r-normal-*-12-*-*-*-*-*-iso10646-1")
(setf *normal-border-width* 0
      *maxsize-border-width* 0
      *transient-border-width* 1
      *window-border-style* :thick)     ; :thick :thin :tight :none

(setf *startup-message* "Never Stop Hacking!"
      *mouse-focus-policy* :sloppy ;; :click, :ignore, :sloppy
      ;;Set the message and input box to the bottom right. This way it overlaps with mode-line.
      *message-window-gravity* :bottom-left
      *input-window-gravity* :bottom-left
      *frame-number-map* "123qwe"
      *window-number-map* "123qwe")
</code></pre></div></div>

<p>Для определения префикса клавиш используется строка:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(set-prefix-key (kbd "s-s"))
</code></pre></div></div>

<p>В данном случае назначена комбинация Win-S.</p>

<p>Для определения основных клавиатурных комбинаций лучше всего определить пару функций:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>;; define keys
(defmacro defkey-top (key cmd)
   `(define-key *top-map* (kbd ,key) ,cmd))

(defmacro defkeys-top (&amp;amp;rest keys)
   (let ((ks (mapcar #'(lambda (k) (cons 'defkey-top k)) keys)))
   `(progn ,@ks)))

(defmacro defkey-root (key cmd)
   `(define-key *root-map* (kbd ,key) ,cmd))

(defmacro defkeys-root (&amp;amp;rest keys)
   (let ((ks (mapcar #'(lambda (k) (cons 'defkey-root k)) keys)))
   `(progn ,@ks)))
</code></pre></div></div>

<p>После чего определение клавиатурных комбинаций записывается очень просто:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(defkeys-top
 ("s-RET"     "exec sakura")
 ("s-p"       "dmenu")
 ("s-R"       "reinit")
 ("s-Q"       "quit")
 ("s-b"       "mode-line"))
</code></pre></div></div>

<p>Запускать программы через клавиатурные комбинации можно двумя способами:</p>

<ol>
  <li>
    <p>Используя в качестве команды <em>exec command</em></p>
  </li>
  <li>
    <p>Определить функцию через RunOnRaise. Данная функция позволяет, если программа не была запущена до сих пор, запустить ее, а если была запущена, то переключиться на нее. Очень удобно! Сначала прописываем саму функцию, а затем прописываем сочетание клавиш:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> (defcommand firefox () ()
    "Run or switch to firefox."
    (run-or-raise "firefox" '(:class "Firefox")))

 (defkeys-root
    ("f"         "firefox"))
</code></pre></div>    </div>
  </li>
</ol>

<p>Для того, чтобы получить информацию о группах и окнах, которые расположены в этих группах или для вывода дополнительной информации, типа температуры процессора, не нужно использовать сторонних программ, достаточно прописать в конфигурации использование <em>modeline</em>… Для этого прописываем в конфигурации следующие строки, которые задают внешний вид строки и описывают ее содержимое.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>;;;; The Mode Line
(setf *mode-line-background-color* "DarkRed"
      *mode-line-foreground-color* "White"
      *mode-line-border-color*     "White"
      *mode-line-timeout*          1
      *mode-line-screen-position*  :top
      *window-format*           "^B^8*%n%s%m%30t  :: ^7*"
      *group-format*           "%t"
      *screen-mode-line-format* (list "^B" `(:eval (stumpwm:run-shell-command "printf \"`date +'%a, %d %B %H:%M'`\"" t))
              "  ^ B||  "
              `(:eval (stumpwm:run-shell-command "printf \"`sensors| grep temp3| awk '&amp;#123;print ($2)}'`\"" t))
              "   ||   ^b^7*%g^B   ||   %w  ^1*%N" ; Current group and frames
))

;; turn on/off the mode line for the current screen only.
(if (not (head-mode-line (current-head)))
    (toggle-mode-line (current-screen) (current-head)))
</code></pre></div></div>

<p>При использовании внешних программ для получения информации следует обратить внимание на то, что вывод обычно заканчивается символом перевода строки. И если в modeline вывести данный вывод, то modeline получиться высотой в две строки, причем вторая строка будет пустовать. Для избежание данной ситуации существует два пути:</p>

<ol>
  <li>
    <p>Использование потока вывода с преобразованием последовательности символов.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> (run-shell-command "date +'%a %d %b %H:%M:%S' | tr -d [:cntrl:]" t)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Использование для вывода функции <strong>printf</strong> (как это показано выше в конфигурации <em>modeline</em>)</p>
  </li>
</ol>

<p>Я использую второй вариант, просто потому, что он мне больше нравиться. Как уже стало понятным, <em>modeline</em> можно разбивать на несколько строк, для получения более информативного вывода.</p>

<p>Необходимо так же помнить, что в <em>modeline</em> до сих пор не реализована возможность выравнивания текста по правому краю.</p>

<p>Для автоматического запуска программ при старте оконного менеджера необходимо использовать следующий код:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(run-shell-command "xmodmap ~/.Xmodmap")
(run-shell-command "xrdb ~/.Xdefaults")
</code></pre></div></div>

<p>Конфигурирование <strong>stumpwm</strong> возможно осуществлять несколькими способами:</p>

<ol>
  <li>
    <p>Правкой файла конфигурации, с последующей его повторной загрузкой</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> (defcommand reinit () ()
   (run-commands "reload" "loadrc"))

 (defkeys-top
    ("s-R"       "reinit"))
</code></pre></div>    </div>
  </li>
  <li>
    <p>Использование сочетаний клавиш для ввода нужного кода lisp. Для этого жмем <strong>C-t :</strong> и вводим нужные нам функции или команды. В примере используется префикс по умолчанию, если он был изменен в конфиге, то нужно использовать именно его.</p>
  </li>
</ol>

<p>В <strong>stumpwm</strong> так же, как и во многих тайловых оконных менеджерах можно определять правила расположения окон по определенным группам. Сначала нужно описать сами группы:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>;; Create groups
(defvar group-names "123qwe")

(dotimes (i 6)
   (define-key *top-map* (kbd (format nil "s-~a" (char group-names i)))
   (format nil "gselect ~a" (1+ i)))
   (define-key *top-map* (kbd (format nil "s-C-~a" (char group-names i)))
   (format nil "gmove ~a" (1+ i))))

(defmacro make-groups (&amp;amp;rest names)
   (let ((ns (mapcar #'(lambda (n) (cat "gnew " n)) names)))
   `(run-commands ,@ns)))

(make-groups "2" "3" "q" "w" "e")
(run-commands "gselect 1" "grename 1")
</code></pre></div></div>

<p>Теперь остается только задать правила расположения окон по группам:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>;; Clear rules
(clear-window-placement-rules)

(define-frame-preference "1"
  ;; frame raise lock (lock AND raise == jumpto)
  (0 t   t :title "emacs")
  (0 t   t :class "XTerm"))

(define-frame-preference "2"
  ;; frame raise lock (lock AND raise == jumpto)
  (0 t   t :class "Firefox"))

(define-frame-preference "3"
  ;; frame raise lock (lock AND raise == jumpto)
  (0 t   t :instance "aumix")
  (0 t   t :class "MPlayer")
  (0 t   t :class "Avidemux"))
</code></pre></div></div>

<p>Можно еще долго перечислять возможности данного оконного менеджера. Но тут я думаю уже остановиться.</p>

<p>Мой файл конфигурации stumpwm можно найти по адресу <a href="http://github.com/Juev/stumpwm-config" rel="nofollow">github.com/Juev/stumpwm-config</a></p>

<p>И напоследок внешний вид:</p>

<p><a href="https://static.juev.org/2009/09/stumpwm.png"><img class="size-medium wp-image-603 aligncenter" title="stumpwm" src="https://static.juev.org/2009/09/stumpwm-300x240.png" alt="StumpWM" width="300" height="240" /></a></p>
</div>
<div class="meta"><div class="pagination">
 <p class="previous">Previous post: <a rel="prev" href="https://www.juev.org/2009/09/13/xbindkeys/" title="View xbindkeys - сочетания в стиле emacs">xbindkeys - сочетания в стиле emacs</a></p>
 <p class="next">Next post: <a rel="next" href="https://www.juev.org/2009/09/29/dotpac/" title="View dotpac">dotpac</a></p></div>
</div>
</div>
  </div><!-- noindex -->
  <div class="footer">
    <div class="width-fix">
      <p><a href="https://www.juev.org/articles.html" rel="nofollow">Список статей</a> :: <a href="https://www.juev.org/recommendations/" rel="nofollow">Рекомендации</a> :: <a href="https://www.juev.org/atom.xml" rel="nofollow">RSS</a></p>
      <p>&copy;&nbsp;<a href="https://denis.evsyukov.org">Denis Evsyukov</a>,&nbsp;2008&ndash;2019&nbsp;Contact me via <script type="text/javascript">document.write("<n uers=\"znvygb:qravf\100riflhxbi\056bet\">Rznvy</n>".replace(/[a-zA-Z]/g,function(c){return String.fromCharCode((c<="Z"?90:122)>=(c=c.charCodeAt(0)+13)?c:c-26);}));</script>,&nbsp;
      <a href="https://twitter.com/#!/Juev" rel="nofollow">twitter</a> or&nbsp;
      <a href="https://github.com/Juev" rel="nofollow">github</a></p>
    </div>
  </div>
  <script async src="https://static.juev.org/assets/js/master.a08e4d4f.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-26480484-5', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
