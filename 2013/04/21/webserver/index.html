<!DOCTYPE html>
<!--
    You can email me with PGP-key: 0xE8ADA1A55B3CA4EA
-->
<html lang="ru">
<head>
  <link rel="dns-prefetch" href="https://static.juev.org">
  <meta charset="utf-8">
  <title>Настройка вебсервера</title>
  <meta name="description" content="Вчера решил снова завести себе сервер.  Единственно, решил попробовать не Amazon, а что-то иное. Выбор пал на DigitalOcean, из-за того, что стоимость сервера очень низкая, это еще при условии испол...">
  <meta name="yandex-verification" content="59bb4b98872e096b" />
  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- end -->
  <link rel="canonical" href="https://www.juev.org/2013/04/21/webserver/">
  <link rel="shortcut icon" href="https://static.juev.org/favicon.ico">
  <link rel="apple-touch-icon" href="https://www.juev.org/apple-touch-icon.png">
  <link rel="alternate" type="application/atom+xml" title="ATOM Feed" href="https://www.juev.org/atom.xml">
  <link rel="stylesheet" type="text/css" href="https://static.juev.org/assets/css/master.6bbfa8b61.css">
  <link rel="prev" href="https://www.juev.org/2013/04/20/jekyll-tags/">
  <link rel="next" href="https://www.juev.org/2013/05/01/vim-screencast/">
  <!-- og:meta -->
  <meta content="Настройка вебсервера" property="og:title">
  <meta content="Вчера решил снова завести себе сервер.  Единственно, решил попробовать не Amazon, а что-то иное. Выбор пал на DigitalOcean, из-за того, что стоимость сервера очень низкая, это еще при условии испол..." property="og:description">
  <meta content="https://www.juev.org/2013/04/21/webserver/" property="og:url">
  <meta content="2013-04-21T12:56:00+04:00" property="article:published_time">
  <meta content="server" property="article:tag">
  <meta content="ubuntu" property="article:tag">
  <meta content="apache" property="article:tag">
  <meta content="hosting" property="article:tag">
  <meta content="security" property="article:tag">
  <meta content="https://static.juev.org/images/calvin.png" property="og:image">
  <meta content="https://denis.evsyukov.org" property="article:author">
  <!-- end og:meta  -->
  <!-- twitter card -->
  <meta content="summary_large_image" name="twitter:card">
  <meta content="Настройка вебсервера" name="twitter:title">
  <meta content="Вчера решил снова завести себе сервер.  Единственно, решил попробовать не Amazon, а что-то иное. Выбор пал на DigitalOcean, из-за того, что стоимость сервера очень низкая, это еще при условии испол..." property="twitter:description">
  <meta content="https://www.juev.org/2013/04/21/webserver/" name="twitter:url">
  <meta content="https://static.juev.org/images/calvin.png" property="twitter:image:src">
  <!-- end twitter card -->
</head>
<body class="wide">
  <div class="navigation">
    <div class="width-fix">
        <a href="https://www.juev.org/" id="home" rel="nofollow"></a>
      <ul>
        <li><a href="https://www.juev.org/articles.html" rel="nofollow">Статьи</a></li>
        <li>|</li>
        <li><a href="https://denis.evsyukov.org">Об авторе</a></li>
      </ul>
    </div>
  </div>
  <div class="primary-content width-fix">
    <div class="entry"><h1 class="title">Настройка вебсервера</h1>
<div id="metainfo">
<span class="date">21 April 2013</span>
<span class="tags"><a href="https://www.juev.org/tags/#server" title="View posts tagged with &quot;server&quot;" rel="nofollow">#server</a><a href="https://www.juev.org/tags/#ubuntu" title="View posts tagged with &quot;ubuntu&quot;" rel="nofollow">#ubuntu</a><a href="https://www.juev.org/tags/#apache" title="View posts tagged with &quot;apache&quot;" rel="nofollow">#apache</a><a href="https://www.juev.org/tags/#hosting" title="View posts tagged with &quot;hosting&quot;" rel="nofollow">#hosting</a><a href="https://www.juev.org/tags/#security" title="View posts tagged with &quot;security&quot;" rel="nofollow">#security</a></span>
</div>
<div class="post"><p>Вчера решил снова завести себе сервер. Единственно, решил попробовать не Amazon, а что-то иное.</p>

<p>Выбор пал на <a href="https://www.digitalocean.com" title="DigitalOcean">DigitalOcean</a>, из-за того, что стоимость сервера очень низкая, это еще при условии использования виртуализации KVM и жестких дисков SSD.</p>

<p>Мне требуется размещать только статические сайты, поэтому я выбрал самый дешевый тариф в $5 в месяц. При этом выделяется сервер с 512 мегабайтами памяти, 20 гигабайтами высокоскоростного жесткого диска. Регистрация очень простая и для размещения сервера требуется либо произвести оплату с помощью PayPal или зарегистрировать в аккаунте свою пластиковую карту.</p>

<p>Сервера можно размещать или в Нью-Йорке или в Амстердаме. Но как оказалось далее, в Амстердаме не удастся разместить сервера за $5 или $10, так как в этой зоне наблюдаются проблемы с выделением адресного пространства.</p>

<p>Зарегистрировал свой сервер в Нью-Йорке и был приятно удивлен, пинги до сервера стабильные и составляют порядка 160 миллисекунд.</p>

<p>При регистрации выбрал сервер на основе операционной системы Ubuntu 12.04 32bit. Выбор пал на 32 бита из-за ограничений в размере оперативной памяти. Запуск сервера был произведен уже спустя минуту после заказа. Довольно приятный аспект.</p>

<p>В отличие от Amazon, на сервере DigitalOcean по умолчанию доступ предоставляется только пользователю Root, и вход осуществляется по паролю. Поэтому первым делом нужно было закрыть данную дыру в безопасности. Чтобы в дальнейшем было проще, опишу всю последовательность действий по настройке сервера.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(root)# locale-gen ru_RU.UTF-8
(root)# update-locale LANG=ru_RU.UTF-8 LC_MESSAGES=POSIX
(root)# dpkg-reconfigure locales

(root)# adduser ubuntu
(root)# adduser ubuntu sudo
(root)# apt-get update
(root)# apt-get install vim
(root)# vim /etc/ssh/sshd_config
</code></pre></div></div>

<p>Здесь находим строки, снимаем при необходимости комментарий, и меняем значение с <code class="highlighter-rouge">yes</code> на <code class="highlighter-rouge">no</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PermitRootLogin no
PasswordAuthentication no
</code></pre></div></div>

<p>Теперь, перед тем, как перезапустим сервис ssh, нам необходимо передать свои ключи на сервер (команды выполняются на локальной машине):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ssh-copy-id -i ~/.ssh/id_dsa.pub ubuntu@198.199.81.151
</code></pre></div></div>

<p>Примечание: в OSX утилита ssh-copy-id отсутствует по умолчанию, но ее легко установить с помощью homebrew.</p>

<p>После ввода пароля ключи попадают на сервер и теперь можно попробовать логинится на сервер под вновь созданным пользователем и уже без пароля.</p>

<p>Теперь нужно перезапустить сервис ssh и продолжать настройку (дальнейшие команды уже выполняются на сервере от имени созданного пользователя).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(ubuntu)$ sudo service ssh restart
</code></pre></div></div>

<p>На данном этапе можно попробовать произвести логин на сервер с локальной машины, используя логин <code class="highlighter-rouge">root</code> или парольную аутентификацию, для того, чтобы убедиться, что данные способы входа закрыты.</p>

<p>Теперь настраиваем часовой пояс, ставим сервер точного времени и устанавливаем фаервол:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(ubuntu)$ sudo dpkg-reconfigure tzdata
(ubuntu)$ sudo apt-get install openntpd denyhosts ufw
(ubuntu)$ sudo ufw allow Apache
(ubuntu)$ sudo ufw allow OpenSSH
(ubuntu)$ sudo ufw enable
(ubuntu)$ sudo ufw status verbose
</code></pre></div></div>

<p>На экране должно появится примерно следующее:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Status: active
Logging: on (low)
Default: deny (incoming), allow (outgoing)
New profiles: skip

To                         Action      From
--                         ------      ----
80/tcp (Apache)            ALLOW IN    Anywhere
22/tcp (OpenSSH)           ALLOW IN    Anywhere
80/tcp (Apache (v6))       ALLOW IN    Anywhere (v6)
22/tcp (OpenSSH (v6))      ALLOW IN    Anywhere (v6)
</code></pre></div></div>

<p>Это говорит о том, что теперь все порты сервера закрыты по умолчанию и разрешены соединения только с SSH и Web. Теперь переходим к установке и настройке веб-сервера апач.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(ubuntu)$ sudo apt-get install apache2
(ubuntu)$ sudo a2enmod headers
(ubuntu)$ sudo a2enmod rewrite
(ubuntu)$ sudo a2enmod expires
(ubuntu)$ sudo service apache2 restart
(ubuntu)$ cd /etc/apache2/sites-available/
(ubuntu)$ sudo cp default site.ru
(ubuntu)$ sudo vim site.ru
</code></pre></div></div>

<p>И приводим этот файл примерно к следующему виду (минимальные настройки, необходимые для работы сайта):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
    ServerAdmin ubuntu@site.ru
    ServerName site.ru
    ServerAlias site.ru www.site.ru

    DocumentRoot /home/ubuntu/www/siteru
    &lt;Directory /home/ubuntu/www/siteru&gt;
            Options None
            Order allow,deny
            allow from all
    &lt;/Directory&gt;

    ErrorLog /home/ubuntu/logs/siteru/error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn
&lt;/VirtualHost&gt;
</code></pre></div></div>

<p>Для того, чтобы при перезапуске Apache не появлялось предупреждений, необходимо в файл <code class="highlighter-rouge">/etc/apache2/httpd.conf</code> добавить строку (файл по умолчанию пустой):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ServerName localhost
</code></pre></div></div>

<p>Теперь необходимо создать директории для размещения своего сайта (для этого используется домашняя директория):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(ubuntu)$ cd; mkdir -p www/siteru; mkdir -p logs/siteru
</code></pre></div></div>

<p>Пришла пора активировать свой сайт и перезапускать веб-сервер:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(ubuntu)$ sudo a2ensite site.ru
(ubuntu)$ sudo service apache2 reload
</code></pre></div></div>

<p>Если ошибок при запуске не было, значит все нормально и можно проверять работу. Для этого достаточно в браузере набрать ip-адрес своего сервера, на что он должен будет показать простенькую веб-страницу.</p>

<p>Amazon S3 очень дешевый способ размещения своих сайтов, но он же имеет и ряд недостатков:</p>

<ol>
  <li>Страницы сайта раздаются без сжатия, что значительно играет роль в скорости отдачи.</li>
  <li>Скорость загрузки страниц сайта на сервер на порядки меньше скорости загрузки с помощью rsync. Для сравнения, во время загрузки с использованием s3cmd я тратил порядка 2 минут на загрузку страниц, при использовании rsync у меня уходит порядка 2-3 секунд.</li>
  <li>Нет возможности задавать дополнительные заголовки файлам, как например <code class="highlighter-rouge">Vary: Accept-Encoding</code> или <code class="highlighter-rouge">X-UA-Compatible: IE=Edge,chrome=1</code>.</li>
  <li>Нет возможности управлять переадресацией со страниц сайта, к примеру задать 410 ошибку при удалении определенной страницы.</li>
</ol>

<p>Без всего этого можно обойтись, при условии того, что S3 очень дешевый сервис. Но когда есть возможность использовать что-то лучше, за небольшую доплату, зачем упускать такую возможность?</p>

<p>При использовании Amazon S3, Page Speed для моего сайта оказался на уровне 83-84 балов из 100. Мне удавалось довести это значение  до 99 путем использование предварительного сжатия, но после этого сайт не индексировался поисковыми системами.</p>

<p>Теперь же, после перехода на сервер от DigitalOcean, Page Speed стал ровно 100 балов из 100. На мой взгляд, оно того стоит. Посмотрим теперь, насколько стабильно будет работать сервер.</p>
</div>
<div class="meta"><div class="pagination">
 <p class="previous">Previous post: <a rel="prev" href="https://www.juev.org/2013/04/20/jekyll-tags/" title="View Использование тегов в Jekyll">Использование тегов в Jekyll</a></p>
 <p class="next">Next post: <a rel="next" href="https://www.juev.org/2013/05/01/vim-screencast/" title="View Vim Screencast">Vim Screencast</a></p></div>
</div>
</div>
  </div><!-- noindex -->
  <div class="footer">
    <div class="width-fix">
      <p><a href="https://www.juev.org/articles.html" rel="nofollow">Список статей</a> :: <a href="https://www.juev.org/recommendations/" rel="nofollow">Рекомендации</a> :: <a href="https://www.juev.org/atom.xml" rel="nofollow">RSS</a></p>
      <p>&copy;&nbsp;<a href="https://denis.evsyukov.org">Denis Evsyukov</a>,&nbsp;2008&ndash;2019&nbsp;Contact me via <script type="text/javascript">document.write("<n uers=\"znvygb:qravf\100riflhxbi\056bet\">Rznvy</n>".replace(/[a-zA-Z]/g,function(c){return String.fromCharCode((c<="Z"?90:122)>=(c=c.charCodeAt(0)+13)?c:c-26);}));</script>,&nbsp;
      <a href="https://twitter.com/#!/Juev" rel="nofollow">twitter</a> or&nbsp;
      <a href="https://github.com/Juev" rel="nofollow">github</a></p>
    </div>
  </div>
  <script async src="https://static.juev.org/assets/js/master.a08e4d4f.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-26480484-5', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
