---
layout: post
title: TL-WR1043ND откат DD-WRT на стандартную прошивку
keywords: tplink, flash, ddwrt, dd-wrt
gplus: https://plus.google.com/116661482374124481456/posts/9cuZ1iZHK1r
date: 2011-10-07 18:23
tags:
- tips
- ddwrt
- tplink
---
Долгое время я использовал в качестве домашнего роутера Asus wl-500gpv2, отличный роутер, многофункциональный. Прошивка Олега позволила избавиться от ряда проблем с маршрутизацией в локальной сети при поднятом VPN. Канал держался на протяжении нескольких месяцев, стабильность устраивала.

Однако данный роутер был выпущен уже достаточно давно и явно не был рассчитан на те скорости, что сейчас предоставляют провайдеры. И все бы ничего, да мой провайдер использует для подключения к интернету VPN, который довольно сильно нагружает процессор, что сказывается на общей производительности сети. Таким образом при работе на локальных торрентах я наблюдал вместо 10-11 мегабайт в секунду максимум 6-7.

Именно это заставило меня задуматься о покупке нового устройства. Мне повезло и на глаза попался роутер TP-Link TL-WR1043ND, недолго думая я его приобрел. Все таки гигабитные порты, функционал, который заложен в него, при стоимости менее 2 тыс рублей -- это просто подарок! Упускать такой шанс было бы глупостью.

Настройка роутера заняла от силы минут пять, это если учитывать еще прописывание локальных маршрутов провайдера на роутере. После чего роутер у меня проработал пару месяцев.  Стабильность работы, его производительность только радовали. Но буквально несколько дней назад я озадачился качеством SIP-звонков. Долгое время мы использовали SIP и мирились с тем, что качество было не очень хорошим, были прерывания звука, но в целом при его стоимости нас устраивало. А тут мне пришлось позвонить с сотового через SIP, используя при этом мобильный интернет от MTS. Качество связи меня просто поразило! И я понял, что проблема заключается не в технологии/провайдере/программе, а только в том, что мы находимся за NAT.

## Проблема

Стал рассматривать различные решения, которые предлагаются в сети. И в качестве одного из них предлагалось прошить роутер прошивкой DD-WRT, в которую включался модуль SIP-proxy.  Еще до этого момента я был наслышан об этой прошивке, поэтому решился попробовать.

Сам процесс протекал довольно просто и быстро, буквально через 10 минут я уже был обладателем роутера с установленной прошивкой DD-WRT. И вот тут то начались проблемы.

Я пытался использовать на роутере DNS-сервера OpenDNS, так как давно хотел сделать это именно на роутере, а не только на компьютере, но VPN не поднимался. Попытался руками прописать DNS-сервера провайдера, так же безрезультатно. И только спустя почти час мне удалось поднять VPN отключив при этом сервис DNSMasq на роутере.

Заработать заработал, но при этом uPNP не работало, кнопка QSS для быстрой настройки беспроводных устройств так же не работала. Торрент еле шевелился, хотя порт был заранее проброшен и открыт.

Решил проверить SIP. Каково же было мое удивление, когда обнаружил, что SIP-proxy не дает никаких преимуществ при соединении. И это при условии того, что я потерял еще массу других удобств.

## Шьем официальную прошивку

Решил прошиться на стандартную прошивку. Но основная масса статей гласила, что прошить роутер обратно практически не возможно. Это меня еще больше смутило. Продолжил поиск и решил обратиться к опыту людей, работающих с прошивками OpenWRT. Это прошивка для специалистов и требует особых навыков и знаний, и сам процесс прошивки протекает несколько иначе.

Именно у них я нашел вариант прошивки, при котором используется доступ через telnet или ssh ([ссылка][1]). Единственно, описанный способ требует установки дополнительных пакетов на роутер для распаковки zip-архива. И я решил несколько упростить этот процесс.

[1]: http://wiki.openwrt.org/doc/howto/generic.uninstall
    "Back to original firmware - OpenWRT"

Для начала с официального сайта [TP-Link][] качаем последнюю версию прошивки.  Распаковываем файл, переименовываем его во что-нибудь попроще (к примеру wl1043.bin) и кладем его в папку Public на сервисе Dropbox.

[TP-Link]: http://www.tp-link.com/en/support/download/?model=TL-WR1043ND
    "TL-WR1043ND"

Подключаемся к роутеру по ssh (если он был предварительно включен), либо по telnet:

    $ ssh root@192.168.1.1
        password: password

Естественно, что в качестве пароля указываем тот, что был установлен при использовании прошивки DD-WRT. Я надеюсь, что интернет у вас на этом этапе еще работает, выполняем команды:

    # cd /tmp
    # wget http://dl.dropbox.com/234234/wl1043.bin

В качестве ссылки необходимо использовать ту, что выдаст вам ваш аккаунт Dropbox для файла прошивки, в примере указаны случайные числа. И теперь прошиваем наше устройство:

    # mtd -r write /tmp/wl1043.bin linux

Обращаю внимание на то, что в конце команды нужно указывать именно linux, а не firmware, как в примере для прошивки OpenWRT. Проверить, что именно нужно использовать в качестве аргумента команды можно следующим образом:

    # cat /proc/mtd

Вывод команды указывает разделы, доступные в системе, первым идет загрузчик и затем ядро и остальные разделы.  В прошивке DD-WRT ядро называется linux, и именно его нужно использовать в команде mtd.

После того, как дали команду `mtd -r` остается только ждать и надеяться на то, что во время прошивки не отключиться свет. Прошивка идет достаточно быстро, минуты 3-4. По завершении соединение ssh разорвется, еще немного ждем и пробуем зайти браузером по адресу `192.168.1.1`. Если все прошло нормально и увидели стандартный интерфейс прошивки TP-Link, то нужно выключить устройство и примерно через минуту включить вновь (желательно сбросить устройство методом 30/30/30). После чего останется только настроить его вновь.

## Итоги

Вот так просто оказалось вернуться на заводскую прошивку. Странно даже, что пишут о невозможности данной операции или о ее рискованности. Риск не более велик, чем при прошивке через веб-интерфейс.

А для себя я сделал вывод, что прошивка DD-WRT на роутере TP-Link TL-WR1043ND совершенно ничего не стоит. И лучше всего использовать стандартную прошивку, которая показывает достаточную функциональность и очень хорошую стабильность.
